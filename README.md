# ğŸ¨ AstrBot Plugin ComfyUI Pro

ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ AstrBot æ’ä»¶ï¼Œæ—¨åœ¨å°†æœ¬åœ°çš„ **ComfyUI** æ— ç¼é›†æˆåˆ° **AstrBot** ä¸­ã€‚

å®ƒä¸ä»…æ”¯æŒåŸºç¡€çš„æ–‡ç”Ÿå›¾ï¼Œè¿˜å¼•å…¥äº† LLMï¼ˆå¤§è¯­è¨€æ¨¡å‹ï¼‰ä½œä¸ºâ€œæç¤ºè¯å·¥ç¨‹å¸ˆâ€ï¼Œèƒ½å¤Ÿå°†ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€æè¿°è‡ªåŠ¨è½¬åŒ–ä¸º ComfyUI å¯è¯†åˆ«çš„é«˜è´¨é‡è‹±æ–‡ Promptã€‚åŒæ—¶æ”¯æŒå¤šå·¥ä½œæµåˆ‡æ¢ã€æ•æ„Ÿè¯è¿‡æ»¤å’Œé«˜åº¦è‡ªå®šä¹‰é…ç½®ã€‚

## âœ¨ ä¸»è¦åŠŸèƒ½

### ğŸ¤– æ™ºèƒ½ç»˜å›¾ä½“ç³»
*   **LLM è‡ªç„¶è¯­è¨€ç”Ÿå›¾ (Zero-Config)**ï¼šæ— éœ€é…ç½®å¤æ‚çš„å‡½æ•°è°ƒç”¨ (Function Call)ï¼Œæ’ä»¶é€šè¿‡ç‹¬ç‰¹çš„ Prompt å·¥ç¨‹è®© LLM ç†è§£ç”»å›¾æŒ‡ä»¤ã€‚ç”¨æˆ·åªéœ€è¯´â€œå¸®æˆ‘ç”»ä¸€ä¸ª...â€ï¼ŒLLM å³è‡ªåŠ¨ä¼˜åŒ–æç¤ºè¯å¹¶è§¦å‘ç”Ÿæˆã€‚
*   **æŒ‡ä»¤ç”Ÿå›¾**ï¼šæä¾› `/ç”»å›¾` å’Œ `/ç”»å›¾no` æŒ‡ä»¤ï¼Œé€‚åˆè¿›é˜¶ç”¨æˆ·ç›´æ¥è¾“å…¥è‹±æ–‡ Tag è¿›è¡Œç²¾å‡†æ§åˆ¶ã€‚

### ğŸ”Œ ComfyUI æ·±åº¦é›†æˆ
*   **å¤šå·¥ä½œæµçƒ­åˆ‡æ¢**ï¼šæ”¯æŒå¯¼å…¥ ComfyUI çš„ API æ ¼å¼ (`.json`) å·¥ä½œæµï¼Œå¹¶æ”¯æŒåœ¨ AstrBot é…ç½®ä¸­å¿«é€Ÿåˆ‡æ¢ä¸åŒé£æ ¼ï¼ˆå¦‚ï¼šSDXLã€äºŒæ¬¡å…ƒã€å†™å®ã€LoRAç‰¹å®šæµç­‰ï¼‰ã€‚
*   **æ™ºèƒ½å‚æ•°æ³¨å…¥**ï¼š
    *   **Prompt æ³¨å…¥**ï¼šè‡ªåŠ¨è¯†åˆ«å¹¶å°†æç¤ºè¯æ³¨å…¥åˆ°æŒ‡å®šçš„ `CLIP Text Encode` èŠ‚ç‚¹ã€‚
    *   **éšæœºç§å­æ§åˆ¶**ï¼šè‡ªåŠ¨æ‰«æå…¨å·¥ä½œæµï¼Œè¯†åˆ«å¹¶éšæœºåŒ– `seed` / `noise_seed` å‚æ•°ï¼Œæœç»ç”Ÿæˆé‡å¤å›¾ç‰‡ã€‚

### ğŸ›¡ï¸ å®Œå–„çš„é£æ§ä¸æƒé™ç³»ç»Ÿ
*   **åˆ†çº§è¿ç¦è¯è¿‡æ»¤**ï¼šå†…ç½® `Lite` (è½»åº¦) å’Œ `Full` (ä¸¥æ ¼) ä¸¤çº§è¿ç¦è¯åº“ï¼Œæ”¯æŒä¸­è‹±æ–‡æ•æ„Ÿè¯æ£€æµ‹ã€‚
*   **å·®å¼‚åŒ–ç­–ç•¥**ï¼šå¯ä¸ºâ€œç§èŠâ€å’Œâ€œä¸åŒçš„ç¾¤ç»„â€åˆ†åˆ«è®¾ç½®ä¸åŒçš„è¿ç¦ç­‰çº§ï¼ˆä¾‹å¦‚ï¼šç§èŠæ”¾å¼€ï¼Œå…¬å¼€ç¾¤ä¸¥æ ¼è¿‡æ»¤ï¼‰ã€‚
*   **ç™½åå•æœºåˆ¶**ï¼šæ”¯æŒè®¾ç½®â€œç™½åå•ç¾¤ç»„â€ï¼Œä»…å…è®¸åœ¨æŒ‡å®šç¾¤å†…ä½¿ç”¨ç”»å›¾åŠŸèƒ½ã€‚
*   **å…¨å±€é”å®šæ¨¡å¼**ï¼šä¸€é”®å¼€å¯ Lockdown æ¨¡å¼ï¼Œæ­¤æ—¶ä»…ç®¡ç†å‘˜å¯ä½¿ç”¨ç”»å›¾åŠŸèƒ½ã€‚

### ğŸ‘® ç®¡ç†å‘˜ç‰¹æƒ
*   **è¶…çº§æƒé™**ï¼šç®¡ç†å‘˜å¯é…ç½®â€œæ— è§†å†·å´æ—¶é—´â€ã€â€œæ— è§†ç™½åå•é™åˆ¶â€ã€â€œæ— è§†æ•æ„Ÿè¯è¿‡æ»¤â€ã€‚
*   **çƒ­ç®¡ç†æŒ‡ä»¤**ï¼šç®¡ç†å‘˜å¯é€šè¿‡ `/comfy_use` ç­‰æŒ‡ä»¤åœ¨å¯¹è¯çª—å£ç›´æ¥åˆ‡æ¢å·¥ä½œæµï¼Œæ— éœ€è¿›å…¥åå°ã€‚
*   **è‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯**ï¼šåœ¨é…ç½®é¢æ¿ç›´æ¥ç¼–è¾‘ LLM çš„ System Promptï¼Œå®šåˆ¶ä½ çš„â€œAI ç»˜ç”»åŠ©æ‰‹â€çš„äººè®¾å’Œå›å¤æ ¼å¼ã€‚

## ğŸ“¦ å®‰è£…æ–¹æ³•

1.  åœ¨ AstrBot çš„æ’ä»¶ç®¡ç†é¢æ¿ä¸­ï¼Œè¾“å…¥ä»“åº“åœ°å€è¿›è¡Œå®‰è£…ï¼š
    ```
    https://github.com/lumingya/astrbot_plugin_comfyui_pro
    ```
2.  ç¡®ä¿ä½ çš„æœ¬åœ°ç”µè„‘ä¸Šå·²ç»è¿è¡Œäº† **ComfyUI**ã€‚
    *   é»˜è®¤åœ°å€ï¼š`http://127.0.0.1:8188`
    *   **æ³¨æ„**ï¼šComfyUI å¿…é¡»æ­£å¸¸å¯åŠ¨æ‰èƒ½ä½¿ç”¨æ­¤æ’ä»¶ã€‚

---

## âš ï¸ æ·»åŠ æ–°å·¥ä½œæµï¼ˆé‡è¦ï¼ï¼‰

ç”±äº AstrBot çš„æ¶æ„ç¼“å­˜æœºåˆ¶ï¼Œæ·»åŠ æ–°çš„ ComfyUI å·¥ä½œæµæ–‡ä»¶ (`.json`) åï¼Œ**å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œ**æ‰èƒ½åœ¨é…ç½®é¢æ¿çœ‹åˆ°æ–°é€‰é¡¹ï¼š

1.  **å¯¼å‡ºå·¥ä½œæµ**ï¼š
    *   åœ¨ ComfyUI è®¾ç½®ä¸­å¼€å¯ **Enable Dev mode Options**ã€‚
    *   ç‚¹å‡»èœå•ä¸­çš„ **Save (API Format)** å¯¼å‡º `.json` æ–‡ä»¶ã€‚
    *   *æ³¨æ„ï¼šå¿…é¡»æ˜¯ API Formatï¼Œæ™®é€š Save æ— æ³•ä½¿ç”¨ã€‚*
2.  **æ”¾å…¥æ–‡ä»¶å¤¹**ï¼š
    *   å°† `.json` æ–‡ä»¶æ”¾å…¥æ’ä»¶ç›®å½•ä¸‹çš„ `workflow` æ–‡ä»¶å¤¹ä¸­ã€‚
    *   è·¯å¾„é€šå¸¸ä¸ºï¼š`data/plugins/astrbot_plugin_comfyui_pro/workflow/`
3.  **åˆ·æ–°åŠ è½½ (å…³é”®æ­¥éª¤)**ï¼š
    1.  åœ¨ AstrBot åå°ç‚¹å‡» **â€œé‡è½½æ’ä»¶â€**ã€‚
    2.  **åˆ·æ–°ç½‘é¡µæµè§ˆå™¨** (F5)ã€‚
    3.  **å†æ¬¡ç‚¹å‡»â€œé‡è½½æ’ä»¶â€**ã€‚
4.  æ­¤æ—¶æ‰“å¼€æ’ä»¶é…ç½®é¡µé¢ï¼Œä½ åº”è¯¥èƒ½åœ¨â€œå·¥ä½œæµæ–‡ä»¶åâ€ä¸‹æ‹‰åˆ—è¡¨ä¸­çœ‹åˆ°æ–°æ·»åŠ çš„æ–‡ä»¶äº†ã€‚

---

## âš™ï¸ é…ç½®è¯´æ˜

åœ¨ AstrBot ä»ªè¡¨ç›˜ -> æ’ä»¶ -> `astrbot_plugin_comfyui_pro` ä¸­ç‚¹å‡»è®¾ç½®ï¼š

### 1. åŸºç¡€è¿æ¥
*   **Server Address**: ComfyUI çš„åœ°å€ï¼Œé€šå¸¸æ˜¯ `127.0.0.1:8188`ã€‚

### 2. å·¥ä½œæµè®¾ç½® (Workflow Settings)
*   **JSON File**: é€‰æ‹©è¦ä½¿ç”¨çš„å·¥ä½œæµæ–‡ä»¶ã€‚
*   **Input Node ID**: **(å…³é”®)** ä½ çš„å·¥ä½œæµä¸­ï¼Œè´Ÿè´£æ¥æ”¶æ­£å‘æç¤ºè¯ (Positive Prompt) çš„ `CLIP Text Encode` èŠ‚ç‚¹ IDã€‚
    *   *å¦‚ä½•æŸ¥çœ‹ IDï¼Ÿ* åœ¨ ComfyUI å¼€å¯å¼€å‘è€…æ¨¡å¼åï¼ŒèŠ‚ç‚¹æ ‡é¢˜ä¸Šæ–¹æ˜¾ç¤ºçš„æ•°å­—å³ä¸º IDã€‚
*   **Output Node ID**: è´Ÿè´£è¾“å‡ºå›¾ç‰‡çš„èŠ‚ç‚¹ IDï¼ˆé€šå¸¸ç•™ç©ºå³å¯ï¼Œæ’ä»¶ä¼šè‡ªåŠ¨å¯»æ‰¾ï¼‰ã€‚

### 3. LLM è®¾ç½® (LLM Settings)

*   **System Prompt**: ä½ å¯ä»¥åœ¨è¿™é‡Œç›´æ¥ç¼–è¾‘å‘ç»™ LLM çš„ç³»ç»Ÿæç¤ºè¯ã€‚å®šä¹‰ LLM å¦‚ä½•ç†è§£ç”¨æˆ·çš„â€œç”»å›¾â€æŒ‡ä»¤ä»¥åŠè¾“å‡ºæ ¼å¼ã€‚
    *   **âš ï¸ æå…¶é‡è¦**ï¼šæ’ä»¶æ˜¯é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼ `æç¤ºè¯[æ˜¯:ï¼š]\s*([^\n]+)` æ¥æ‹¦æˆªç»˜ç”»è¯·æ±‚çš„ã€‚
    *   æ— è®ºä½ æ€ä¹ˆä¿®æ”¹æç¤ºè¯ï¼Œ**å¿…é¡»**ä¿ç•™å¯¹è¾“å‡ºæ ¼å¼çš„è¦æ±‚ï¼Œå³ï¼š**LLM å¿…é¡»åœ¨å›å¤ä¸­åŒ…å«â€œæç¤ºè¯æ˜¯ï¼šxxxâ€**ï¼Œå¦åˆ™æ’ä»¶æ— æ³•æ£€æµ‹åˆ°æ„å›¾ï¼Œ**ä¸ä¼šè§¦å‘ç”»å›¾**ã€‚

### 4. è®¿é—®æ§åˆ¶ (Control)
*   **ç®¡ç†å‘˜ä¸ç™½åå•**ï¼šè®¾ç½®å“ªäº›ç¾¤ã€å“ªäº›äººå¯ä»¥ä½¿ç”¨ç”»å›¾åŠŸèƒ½ã€‚
*   **å†·å´æ—¶é—´**ï¼šé˜²æ­¢åˆ·å±ã€‚
*   **è¿ç¦è¯ç­–ç•¥**ï¼šè®¾ç½®æ•æ„Ÿè¯æ‹¦æˆªç­‰çº§ (none/lite/full)ã€‚

---

## ğŸ“– ä½¿ç”¨æ–¹æ³•

### æ–¹å¼ä¸€ï¼šè‡ªç„¶è¯­è¨€å¯¹è¯ (LLM æ¨¡å¼)
ç›´æ¥åœ¨èŠå¤©ä¸­ä¸æœºå™¨äººå¯¹è¯ï¼Œè§¦å‘ç”»å›¾æ„å›¾ã€‚

*   **ç”¨æˆ·**ï¼šâ€œå¸®æˆ‘ç”»ä¸€åªåœ¨é›¨ä¸­æ‰“ä¼çš„å°çŒ«ï¼Œè¦åœ¨èµ›åšæœ‹å…‹è¡—é“ä¸Šã€‚â€
*   **æœºå™¨äºº**ï¼š(LLM è‡ªåŠ¨åˆ†æ -> ç”Ÿæˆè‹±æ–‡ Prompt -> è°ƒç”¨ ComfyUI -> å‘é€å›¾ç‰‡)
![llmæ¼”ç¤º](https://raw.githubusercontent.com/lumingya/astrbot_plugin_comfyui_pro/main/assets/llm.png)
### æ–¹å¼äºŒï¼šæŒ‡ä»¤æ¨¡å¼
*   `/ç”»å›¾ <æç¤ºè¯>`ï¼šç›´æ¥å‘é€æç¤ºè¯è¿›è¡Œç”Ÿæˆã€‚
![llmæ¼”ç¤º](https://raw.githubusercontent.com/lumingya/astrbot_plugin_comfyui_pro/main/assets/draw.png)

*   `/ç”»å›¾no <æç¤ºè¯>`ï¼šç›´æ¥å‘é€å›¾ç‰‡ï¼ˆä¸å›å¤å¼•ç”¨ï¼‰ã€‚
![llmæ¼”ç¤º](https://raw.githubusercontent.com/lumingya/astrbot_plugin_comfyui_pro/main/assets/drawno.png)


### æ–¹å¼ä¸‰ï¼šç®¡ç†æŒ‡ä»¤ (ä»…ç®¡ç†å‘˜)
*   `/comfy_ls`ï¼šåˆ—å‡ºå½“å‰æ‰€æœ‰å¯ç”¨å·¥ä½œæµã€‚
*   `/comfy_use <æ–‡ä»¶å> [input_id]`ï¼šçƒ­åˆ‡æ¢å½“å‰ä½¿ç”¨çš„å·¥ä½œæµã€‚
    *   ç¤ºä¾‹ï¼š`/comfy_use anime_v2.json 6` (åˆ‡æ¢åˆ° anime_v2ï¼Œå¹¶æŒ‡å®šè¾“å…¥èŠ‚ç‚¹IDä¸º6)
*   `/è¿ç¦çº§åˆ« <lite/full>`ï¼šè°ƒæ•´å½“å‰ç¾¤çš„æ•æ„Ÿè¯æ‹¦æˆªç­‰çº§ã€‚
### æ–¹å¼å››ï¼šæŸ¥çœ‹å¸®åŠ©
*   `/comfyå¸®åŠ©`ï¼šåœ¨èŠå¤©ä¸­ç›´æ¥è·å–å½“å‰æ’ä»¶çš„æ‰€æœ‰å¯ç”¨æŒ‡ä»¤å’Œè¯´æ˜ã€‚
---

## â“ å¸¸è§é—®é¢˜

**Q: ä¸ºä»€ä¹ˆ LLM å›å¤äº†â€œæç¤ºè¯æ˜¯...â€ï¼Œä½†æ²¡æœ‰å‡ºå›¾ï¼Ÿ**
A: è¯·æ£€æŸ¥åå°æ—¥å¿—ã€‚é€šå¸¸æ˜¯å› ä¸º ComfyUI æœªå¯åŠ¨ï¼Œæˆ–è€…å·¥ä½œæµçš„ `Input Node ID` é…ç½®é”™è¯¯ï¼Œå¯¼è‡´æç¤ºè¯æ²¡æœ‰æ³¨å…¥è¿›å»ã€‚

**Q: ç”Ÿæˆçš„å›¾ç‰‡æ€»æ˜¯ä¸€æ ·çš„ï¼Ÿ**
A: æ’ä»¶ä¼šè‡ªåŠ¨å¯»æ‰¾å·¥ä½œæµä¸­çš„éšæœºç§å­å‚æ•° (`seed`, `noise_seed`) å¹¶ä¿®æ”¹ã€‚å¦‚æœä½ çš„å·¥ä½œæµä½¿ç”¨äº†ç‰¹æ®Šçš„ç§å­æ§åˆ¶èŠ‚ç‚¹ï¼Œæ’ä»¶å¯èƒ½æ²¡è¯†åˆ«åˆ°ã€‚

**Q: ä¸‹æ‹‰èœå•é‡Œæ‰¾ä¸åˆ°æˆ‘åˆšæ”¾è¿›å»çš„ json æ–‡ä»¶ï¼Ÿ**
A: è¯·å‚è€ƒä¸Šæ–‡ **ã€æ·»åŠ æ–°å·¥ä½œæµã€‘** ç« èŠ‚ï¼Œéœ€è¦æŒ‰ç…§â€œé‡è½½ -> åˆ·æ–°ç½‘é¡µ -> é‡è½½â€çš„é¡ºåºæ“ä½œã€‚
