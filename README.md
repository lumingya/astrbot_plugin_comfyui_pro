# 🎨 AstrBot Plugin ComfyUI Pro

一个功能强大的 AstrBot 插件，旨在将本地的 **ComfyUI** 无缝集成到 **AstrBot** 中。

它不仅支持基础的文生图，还引入了 LLM（大语言模型）作为“提示词工程师”，能够将用户的自然语言描述自动转化为 ComfyUI 可识别的高质量英文 Prompt。同时支持多工作流切换、敏感词过滤和高度自定义配置。

## ✨ 主要功能

### 🤖 智能绘图体系
*   **LLM 自然语言生图 (Zero-Config)**：无需配置复杂的函数调用 (Function Call)，插件通过独特的 Prompt 工程让 LLM 理解画图指令。用户只需说“帮我画一个...”，LLM 即自动优化提示词并触发生成。
*   **指令生图**：提供 `/画图` 和 `/画图no` 指令，适合进阶用户直接输入英文 Tag 进行精准控制。

### 🔌 ComfyUI 深度集成
*   **多工作流热切换**：支持导入 ComfyUI 的 API 格式 (`.json`) 工作流，并支持在 AstrBot 配置中快速切换不同风格（如：SDXL、二次元、写实、LoRA特定流等）。
*   **智能参数注入**：
    *   **Prompt 注入**：自动识别并将提示词注入到指定的 `CLIP Text Encode` 节点。
    *   **随机种子控制**：自动扫描全工作流，识别并随机化 `seed` / `noise_seed` 参数，杜绝生成重复图片。

### 🛡️ 完善的风控与权限系统
*   **分级违禁词过滤**：内置 `Lite` (轻度) 和 `Full` (严格) 两级违禁词库，支持中英文敏感词检测。
*   **差异化策略**：可为“私聊”和“不同的群组”分别设置不同的违禁等级（例如：私聊放开，公开群严格过滤）。
*   **白名单机制**：支持设置“白名单群组”，仅允许在指定群内使用画图功能。
*   **全局锁定模式**：一键开启 Lockdown 模式，此时仅管理员可使用画图功能。

### 👮 管理员特权
*   **超级权限**：管理员可配置“无视冷却时间”、“无视白名单限制”、“无视敏感词过滤”。
*   **热管理指令**：管理员可通过 `/comfy_use` 等指令在对话窗口直接切换工作流，无需进入后台。
*   **自定义系统提示词**：在配置面板直接编辑 LLM 的 System Prompt，定制你的“AI 绘画助手”的人设和回复格式。

## 📦 安装方法

1.  在 AstrBot 的插件管理面板中，输入仓库地址进行安装：
    ```
    https://github.com/lumingya/astrbot_plugin_comfyui_pro
    ```
2.  确保你的本地电脑上已经运行了 **ComfyUI**。
    *   默认地址：`http://127.0.0.1:8188`
    *   **注意**：ComfyUI 必须正常启动才能使用此插件。

---

## ⚠️ 添加新工作流（重要！）

由于 AstrBot 的架构缓存机制，添加新的 ComfyUI 工作流文件 (`.json`) 后，**必须严格按照以下步骤操作**才能在配置面板看到新选项：

1.  **导出工作流**：
    *   在 ComfyUI 设置中开启 **Enable Dev mode Options**。
    *   点击菜单中的 **Save (API Format)** 导出 `.json` 文件。
    *   *注意：必须是 API Format，普通 Save 无法使用。*
2.  **放入文件夹**：
    *   将 `.json` 文件放入插件目录下的 `workflow` 文件夹中。
    *   路径通常为：`data/plugins/astrbot_plugin_comfyui_pro/workflow/`
3.  **刷新加载 (关键步骤)**：
    1.  在 AstrBot 后台点击 **“重载插件”**。
    2.  **刷新网页浏览器** (F5)。
    3.  **再次点击“重载插件”**。
4.  此时打开插件配置页面，你应该能在“工作流文件名”下拉列表中看到新添加的文件了。

---

## ⚙️ 配置说明

在 AstrBot 仪表盘 -> 插件 -> `astrbot_plugin_comfyui_pro` 中点击设置：

### 1. 基础连接
*   **Server Address**: ComfyUI 的地址，通常是 `127.0.0.1:8188`。

### 2. 工作流设置 (Workflow Settings)
*   **JSON File**: 选择要使用的工作流文件。
*   **Input Node ID**: **(关键)** 你的工作流中，负责接收正向提示词 (Positive Prompt) 的 `CLIP Text Encode` 节点 ID。
    *   *如何查看 ID？* 在 ComfyUI 开启开发者模式后，节点标题上方显示的数字即为 ID。
*   **Output Node ID**: 负责输出图片的节点 ID（通常留空即可，插件会自动寻找）。

### 3. LLM 设置 (LLM Settings)

*   **System Prompt**: 你可以在这里直接编辑发给 LLM 的系统提示词。定义 LLM 如何理解用户的“画图”指令以及输出格式。
    *   **⚠️ 极其重要**：插件是通过正则表达式 `提示词[是:：]\s*([^\n]+)` 来拦截绘画请求的。
    *   无论你怎么修改提示词，**必须**保留对输出格式的要求，即：**LLM 必须在回复中包含“提示词是：xxx”**，否则插件无法检测到意图，**不会触发画图**。

### 4. 访问控制 (Control)
*   **管理员与白名单**：设置哪些群、哪些人可以使用画图功能。
*   **冷却时间**：防止刷屏。
*   **违禁词策略**：设置敏感词拦截等级 (none/lite/full)。

---

## 📖 使用方法

### 方式一：自然语言对话 (LLM 模式)
直接在聊天中与机器人对话，触发画图意图。

*   **用户**：“帮我画一只在雨中打伞的小猫，要在赛博朋克街道上。”
*   **机器人**：(LLM 自动分析 -> 生成英文 Prompt -> 调用 ComfyUI -> 发送图片)

### 方式二：指令模式
*   `/画图 <提示词>`：直接发送提示词进行生成。
*   `/画图no <提示词>`：直接发送图片（不回复引用）。

### 方式三：管理指令 (仅管理员)
*   `/comfy_ls`：列出当前所有可用工作流。
*   `/comfy_use <文件名> [input_id]`：热切换当前使用的工作流。
    *   示例：`/comfy_use anime_v2.json 6` (切换到 anime_v2，并指定输入节点ID为6)
*   `/违禁级别 <lite/full>`：调整当前群的敏感词拦截等级。
### 方式四：查看帮助
*   `/comfy帮助`：在聊天中直接获取当前插件的所有可用指令和说明。
---

## ❓ 常见问题

**Q: 为什么 LLM 回复了“提示词是...”，但没有出图？**
A: 请检查后台日志。通常是因为 ComfyUI 未启动，或者工作流的 `Input Node ID` 配置错误，导致提示词没有注入进去。

**Q: 生成的图片总是一样的？**
A: 插件会自动寻找工作流中的随机种子参数 (`seed`, `noise_seed`) 并修改。如果你的工作流使用了特殊的种子控制节点，插件可能没识别到。

**Q: 下拉菜单里找不到我刚放进去的 json 文件？**
A: 请参考上文 **【添加新工作流】** 章节，需要按照“重载 -> 刷新网页 -> 重载”的顺序操作。
