# 🎨 AstrBot Plugin ComfyUI Pro

一个功能强大的 AstrBot 插件，旨在将你本地的 **ComfyUI** 无缝集成到聊天机器人中。

它不仅支持基础的文生图，更创新的引入了 LLM（大语言模型）作为“提示词工程师”，能够将用户的日常对话自动转化为 ComfyUI 可识别的高质量英文 Prompt。同时，它对 ComfyUI 用户极其友好，支持便捷地导入和切换你自己的工作流，并提供了完善的权限控制和敏感词过滤系统。

导入工作流请务必参考教程。

## 🚀 核心优势：轻松使用你自己的工作流

本插件最大的特点就是让你几乎无缝地使用你在 ComfyUI 中已经搭建好的工作流。只需简单几步，就能将你的创意带入 AstrBot。

### 一、导出你的工作流
 在你的工作流界面，点击菜单的 **`Save (API Format)`** 按钮，将工作流导出为 `.json` 文件。

### 二、找到关键节点 ID
记下你的工作流中 **输入** 和 **输出** 节点的 ID。开启开发者模式后，ID 会显示在每个节点的标题上方。
*   **输入节点 (Input ID)**: 通常是接收提示词的 `CLIP Text Encode` 节点。**（必需）**
*   **输出节点 (Output ID)**: 最终生成图像的 `Save Image` 或 `Preview Image` 节点。**（必选）**

### 三、放置并配置
1.  将导出的 `.json` 文件放入插件的 `workflow` 目录中。
    *   路径为: `data/plugins/astrbot_plugin_comfyui_pro/workflow/`
2.  **重载插件**，然后刷新网页，再次**重载插件**，这样才可以看到你刚才放进的workflow。
3.  进入插件设置，在“工作流设置”中：
    *   选择你刚刚放入的 `.json` 文件。
    *   填入你记下的 **节点ID**。
4.  **完成！** 现在你的机器人就可以使用这个专属工作流进行绘画了。

---

## ✨ 主要功能

### 🔌 ComfyUI 深度集成
*   **便捷工作流导入**: 完美支持 ComfyUI 的 API 格式工作流，让你专注于创意。
*   **多工作流热切换**: 在 AstrBot 后台或通过管理员指令，随时切换不同的模型和风格（如 SDXL、二次元、写实、特定 LoRA 流等）。
*   **智能参数注入**: 自动将提示词注入到你指定的输入节点，并智能寻找种子节点以实现随机化，避免生成重复图片。

### 🤖 智能 LLM 绘图
*   **自然语言生图**: 用户只需说“帮我画一个...”，LLM 即自动分析、优化并生成高质量英文提示词，触发绘图，真正实现“开箱即用”。
*   **指令生图**: 为高级用户保留了传统的 `/画图` 指令，可直接输入英文 Tag 进行精准控制。
*   **高度可定制**: 你可以随时在后台修改 System Prompt，定制你的“AI 绘画助手”人设和回复风格。
*   **注意事项**：该功能依靠于**‘提示词是：’**这个固定格式，如果ai不生成该格式，插件将无法提取提示词。

### 🛡️ 完善的风控与权限
*   **分级违禁词过滤**: 内置 `Lite` 和 `Full` 两级敏感词库，支持中英文过滤，可为不同群组设置不同策略。
*   **白名单与全局锁定**: 可设置仅在白名单群组生效，或一键开启“全局锁定”，仅允许管理员使用。
*   **管理员特权**: 管理员可配置“无视冷却”、“无视白名单”、“无视敏感词”等超级权限。

---

## ⚙️ 详细配置说明

在 AstrBot 仪表盘 -> 插件 -> `astrbot_plugin_comfyui_pro` 中点击设置：

### 1. ComfyUI 连接
*   `Server Address`: 你的 ComfyUI 运行地址，默认为 `127.0.0.1:8188`。

### 2. 工作流设置 (Workflow Settings)
*   `JSON File`: **(核心)** 选择一个你已放入 `workflow` 文件夹的工作流文件。
*   `Input Node ID`: **(核心)** 你的工作流中，接收正向提示词的节点 ID。
*   `Output Node ID`: **(核心)** 输出图片的节点 ID 。

### 3. LLM 设置 (LLM Settings)
*   `System Prompt`: 在这里编辑给 LLM 的系统提示词，定义它如何响应用户的画图请求。
    > ⚠️ **CRITICAL**: 插件通过正则表达式 `提示词[是:：]\s*([^\n]+)` 来识别 LLM 的绘图意图。无论你如何修改 System Prompt，**必须**确保最终 LLM 的回复中包含 **“提示词是：xxx”** 或 **“提示词是: xxx”** 这样的格式，否则插件将无法触发绘图！

### 4. 访问控制 (Control)
*   **管理员与白名单**: 设置管理员 QQ 号和允许使用插件的群号。
*   **冷却时间**: 防止用户刷屏。
*   **违禁词策略**: 为私聊和群聊设置默认的敏感词拦截等级 (none/lite/full)。

---

## 📖 指令与用法

### 方式一：自然语言对话 (推荐)
直接与机器人对话，让它帮你画。
*   **你**: “帮我画一只猫，赛博朋克风格，在下雨的东京街头”
*   **机器人**: (分析需求 -> 生成 Prompt -> 调用 ComfyUI -> 发送图片)

![llm演示](https://raw.githubusercontent.com/lumingya/astrbot_plugin_comfyui_pro/main/assets/llm.png)

### 方式二：直接指令
*   `/画图 <提示词>`: 以合并转发的方式发送图片。
*   
![指令演示](https://raw.githubusercontent.com/lumingya/astrbot_plugin_comfyui_pro/main/assets/draw.png)

*   `/画图no <提示词>`: 直接发送图片，更简洁。

![指令演示](https://raw.githubusercontent.com/lumingya/astrbot_plugin_comfyui_pro/main/assets/drawno.png)

### 方式三：管理指令 (仅管理员)
*   `/comfy_ls`: 列出所有可用的工作流，并显示序号。
*   `/comfy_use <序号> [input_id] [output_id]`: 通过序号快速切换工作流。
*   `/违禁级别 <none/lite/full>`: 调整当前群的敏感词拦截等级。
*   `/comfy帮助`: 查看所有可用指令。

---

## ❓ 常见问题 (FAQ)

**Q: 为什么 LLM 回复了“提示词是...”，但没有出图？**
A: 99% 的可能是配置问题。请检查：
    1.  你的 ComfyUI 服务是否已在本地成功启动？
    2.  插件设置中的 `Input Node ID` 是否填写正确？这是最常见的错误。
    3.  后台日志中是否有报错信息？

**Q: 我新添加的 `.json` 文件在插件设置的下拉菜单里看不到？**
A: 这是 AstrBot 的缓存机制导致。请在后台 **“重载插件”**，然后 **“刷新你的浏览器网页 (F5)”**，然后再次**“重载插件”**，新的选项就会出现。

**Q: 生成的图片总是一样的？**
A: 插件会自动寻找并修改名为 `seed` 或 `noise_seed` 的参数。如果你的工作流使用了非常规的自定义种子节点，插件可能无法识别。请尝试在设置中手动指定 `Seed Node ID`。
